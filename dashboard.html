<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>IoT Medical Dashboard ‚Äî Health Monitor</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.4.0/justgage.min.js"></script>

<style>
:root {
  --accent:#0078d7;--muted:#6b7280;--bg:#f4f7fb;--card:#ffffff;--text:#111;--font:'Poppins',sans-serif;--reading:#0078d7;
}
body.dark {--accent:#64b5f6;--muted:#9ca3af;--bg:#0d1117;--card:#161b22;--text:#e6edf3;--reading:#64b5f6;}
body{font-family:var(--font);margin:0;background:var(--bg);color:var(--text);transition:background .3s,color .3s}
header{background:var(--card);border-bottom:1px solid #e6eefb30;padding:12px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
header img{width:42px;height:42px;border-radius:8px}
header h1{margin:0;font-size:20px;color:var(--accent);flex:1 1 auto;font-weight:600}
.status{display:flex;gap:8px;align-items:center}
.dot{width:12px;height:12px;border-radius:50%;background:#ccc;border:1px solid #aaa;transition:background .3s,box-shadow .3s}
.dot.connected{background:#00cc44;box-shadow:0 0 6px #00cc44;animation:blink 1s infinite ease-in-out}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}
.small{font-size:13px;color:var(--muted)}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:14px;transition:.25s}
.btn:hover{transform:scale(1.05);box-shadow:0 3px 8px rgba(0,0,0,.15)}
.wrapper{padding:14px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
.card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 20px rgba(18,52,86,.08)}
.wide{grid-column:1/-1}
.values{display:flex;gap:12px;justify-content:space-between;flex-wrap:wrap;margin-top:10px}
.valbox{flex:1 1 45%;background:#fafbff20;padding:10px;border-radius:8px;text-align:center}
.valbox h4{margin:0;font-size:13px;color:var(--muted)}
.valbox p{margin:6px 0 0;font-size:18px;color:var(--reading);font-weight:600;transition:color .3s}
#ecgCanvas{height:300px!important;width:100%;overflow-x:auto;}

/* Alert bar */
.alert-bar{position:fixed;top:-60px;left:50%;transform:translateX(-50%);padding:14px 24px;border-radius:10px;color:#fff;font-weight:600;text-align:center;transition:top .4s;z-index:9999;max-width:90%;display:flex;align-items:center;gap:12px;justify-content:space-between}
.alert-bar.show{top:15px}
.alert-critical{background:#d93025}
.alert-warning{background:#e69500}
.alert-btn{background:rgba(255,255,255,.2);border:none;color:#fff;font-weight:600;border-radius:6px;padding:6px 12px;cursor:pointer}
.alert-btn:hover{background:rgba(255,255,255,.35)}

@media(max-width:1024px){.grid{grid-template-columns:1fr}}
@media(max-width:600px){header{flex-direction:column;align-items:flex-start}.btn{width:100%}#ecgCanvas{height:220px!important}}
</style>
</head>

<body>

<!-- Alert -->
<div id="alertBar" class="alert-bar"><span id="alertMsg">‚Äî</span><button class="alert-btn" id="alertOkBtn">OK</button></div>

<header>
  <img src="logo.jpeg" alt="logo" />
  <h1 id="userTitle">IoT Health Dashboard</h1>
  <div class="status"><div class="dot" id="connDot"></div><div class="small" id="connText">Connecting...</div></div>
  <button class="btn" onclick="toggleDarkMode()" style="background:#444">üåì Theme</button>
  <button class="btn" id="pauseBtn" style="background:#e69500">‚è∏ Pause ECG</button>
  <button class="btn" onclick="logout()">Logout</button>
</header>

<div class="wrapper">
  <div class="grid">

    <!-- Live ECG -->
    <div class="card">
      <h3 style="margin-top:0;color:var(--accent)">üíì Live ECG</h3>
      <div class="small">Smooth scrolling ECG waveform (1000 points max)</div>
      <canvas id="ecgCanvas"></canvas>
      <div class="values">
        <div class="valbox"><h4>Latest ECG</h4><p id="latestEcg">--</p></div>
        <div class="valbox"><h4>Last Update</h4><p id="lastUpdate">--</p></div>
      </div>
    </div>

    <!-- Vitals -->
    <div class="card">
      <h3 style="margin-top:0;color:var(--accent)">Vitals</h3>
      <h4 style="text-align:center;color:var(--accent)">üå°Ô∏è Body Temperature</h4>
      <div id="gBody" style="width:100%;height:160px;margin:auto;margin-bottom:20px;"></div>
      <h4 style="text-align:center;color:var(--accent)">üå¨Ô∏è Ambient Temperature</h4>
      <div id="gAmb" style="width:100%;height:160px;margin:auto;margin-bottom:20px;"></div>

      <div class="values">
        <div class="valbox"><h4>Body Temp</h4><p id="numBody">-- ¬∞C / -- ¬∞F</p></div>
        <div class="valbox"><h4>Ambient Temp</h4><p id="numAmb">-- ¬∞C / -- ¬∞F</p></div>
      </div>
      <div class="values">
        <div class="valbox"><h4>Heart Rate</h4><p id="numHR">-- BPM</p></div>
        <div class="valbox"><h4>SpO‚ÇÇ</h4><p id="numSPO2">-- %</p></div>
      </div>
    </div>

    <!-- History -->
    <div class="card wide">
      <h3 style="margin-top:0;color:var(--accent)">üìä Past Records</h3>
      <div class="small">Select a time window to view ECG and Temperature trends.</div>
      <div class="controls">
        <label class="small">Start</label><input id="startDT" type="datetime-local"/>
        <label class="small">End</label><input id="endDT" type="datetime-local"/>
        <select id="preset">
          <option value="">Presets</option>
          <option value="5">Last 5 min</option>
          <option value="15">Last 15 min</option>
          <option value="30">Last 30 min</option>
          <option value="60">Last 1 hr</option>
        </select>
        <button id="loadBtn" class="btn">Load</button>
      </div>
      <canvas id="historyCanvas" style="margin-top:16px;height:260px;width:100%;"></canvas>
    </div>

  </div>
</div>

<script>
/* === Firebase === */
const firebaseConfig={apiKey:"AIzaSyBwGtPqCsq9G74bem7C6qWuJNDoqTH6sts",authDomain:"iot-health-monitor-f0530.firebaseapp.com",databaseURL:"https://iot-health-monitor-f0530-default-rtdb.firebaseio.com"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.database();

/* === Auth === */
auth.onAuthStateChanged(u=>{if(!u)window.location.href="login.html";else userTitle.innerText="IoT Dashboard ‚Äî "+u.email;});
function logout(){auth.signOut().then(()=>window.location.href="login.html");}

/* === Dark Mode === */
function toggleDarkMode(){document.body.classList.toggle("dark");localStorage.setItem("darkMode",document.body.classList.contains("dark"));}
if(localStorage.getItem("darkMode")==="true")document.body.classList.add("dark");

/* === ECG Chart === */
let ecgPaused=false;
pauseBtn.onclick=()=>{ecgPaused=!ecgPaused;pauseBtn.innerText=ecgPaused?"‚ñ∂ Resume ECG":"‚è∏ Pause ECG";pauseBtn.style.background=ecgPaused?"#28a745":"#e69500";}
const ecgCtx=document.getElementById('ecgCanvas').getContext('2d');
const ecgChart=new Chart(ecgCtx,{type:'line',data:{labels:[],datasets:[{label:'ECG',data:[],borderColor:'#ff3b3b',borderWidth:1.8,tension:0.15,pointRadius:0}]},options:{animation:false,responsive:true,scales:{x:{display:false},y:{min:0,max:1024}},plugins:{legend:{display:false}}}});
let ecgMaxPoints=1000;
function addEcgPoint(label,value){if(ecgPaused)return;ecgChart.data.labels.push(label);ecgChart.data.datasets[0].data.push(value);if(ecgChart.data.labels.length>ecgMaxPoints){ecgChart.data.labels.shift();ecgChart.data.datasets[0].data.shift();}ecgChart.update('none');}

/* === Gauges === */
const gBody=new JustGage({id:'gBody',value:0,min:20,max:45,title:'Body Temp (¬∞C)',levelColors:['#00cc66','#ffcc00','#ff3300']});
const gAmb=new JustGage({id:'gAmb',value:0,min:0,max:50,title:'Ambient Temp (¬∞C)',levelColors:['#00cc66','#ffcc00','#ff3300']});

/* === Alerts (Show once + 3 min reminder) === */
const shownAlerts=new Map();const reminderInterval=3*60*1000;
const alertBar=document.getElementById('alertBar'),alertMsg=document.getElementById('alertMsg'),alertOkBtn=document.getElementById('alertOkBtn');
let alertTimeout;
function showAlertOnce(key,msg,type='critical'){const now=Date.now(),last=shownAlerts.get(key)||0;if(now-last<reminderInterval)return;shownAlerts.set(key,now);alertMsg.textContent=msg;alertBar.className=`alert-bar alert-${type} show`;clearTimeout(alertTimeout);alertTimeout=setTimeout(()=>alertBar.classList.remove('show'),6000);}
alertOkBtn.onclick=()=>{alertBar.classList.remove('show');clearTimeout(alertTimeout);}
function toF(c){return (c*9/5+32).toFixed(2);}

/* === Realtime Data === */
db.ref('UpdatedReadings').limitToLast(1).on('value',snap=>{
 if(!snap.exists())return;
 const v=snap.val();const k=Object.keys(v).pop();const e=v[k];
 lastUpdate.innerText=k.replace(/_/g,' ');
 if(e.Temperature){
   const o=parseFloat(e.Temperature.ObjectTemp),a=parseFloat(e.Temperature.AmbientTemp);
   if(!isNaN(o)){gBody.refresh(o);numBody.innerText=`${o.toFixed(2)} ¬∞C / ${toF(o)} ¬∞F`;
     if(o>=38)showAlertOnce('temp_high',`üî• High Body Temp (${o.toFixed(1)} ¬∞C / ${toF(o)} ¬∞F)`,'warning');
     if(o<35)showAlertOnce('temp_low',`ü•∂ Low Body Temp (${o.toFixed(1)} ¬∞C / ${toF(o)} ¬∞F)`,'critical');
   }
   if(!isNaN(a)){gAmb.refresh(a);numAmb.innerText=`${a.toFixed(2)} ¬∞C / ${toF(a)} ¬∞F`;}
 }
 if(e.PulseOximeter){
   const hr=parseFloat(e.PulseOximeter.HeartRate),sp=parseFloat(e.PulseOximeter.SpO2);
   if(!isNaN(hr)){numHR.innerText=hr.toFixed(1)+' BPM';
     if(hr>100)showAlertOnce('tachy',`‚ö†Ô∏è Tachycardia (HR ${hr.toFixed(1)} BPM)`,'critical');
     if(hr<60&&hr>0)showAlertOnce('brady',`‚ö†Ô∏è Bradycardia (HR ${hr.toFixed(1)} BPM)`,'warning');
   }
   if(!isNaN(sp)){numSPO2.innerText=sp.toFixed(1)+' %';
     if(sp<95)showAlertOnce('spo2_low',`ü©∏ Low SpO‚ÇÇ (${sp.toFixed(1)}%)`,'critical');
     else if(sp>=95&&sp<=97)showAlertOnce('spo2_slight',`‚ÑπÔ∏è Slightly Low SpO‚ÇÇ (${sp.toFixed(1)}%)`,'warning');
   }
 }
 if(e.ECG!=null&&!isNaN(e.ECG)){latestEcg.innerText=e.ECG;addEcgPoint(k.split('_')[1],e.ECG);}
});

/* === History Loader === */
const histCtx=document.getElementById('historyCanvas').getContext('2d');
const histChart=new Chart(histCtx,{type:'line',data:{labels:[],datasets:[
 {label:'ECG',data:[],borderColor:'#d33',tension:0.15,pointRadius:0,yAxisID:'y'},
 {label:'Body Temp',data:[],borderColor:'#0078d7',tension:0.2,pointRadius:2,yAxisID:'y1'},
 {label:'Ambient Temp',data:[],borderColor:'#00a884',tension:0.2,pointRadius:2,yAxisID:'y1'}
]},options:{responsive:true,interaction:{mode:'index'},stacked:false,scales:{y:{position:'left',min:0,max:110},y1:{position:'right',min:0,max:50,grid:{drawOnChartArea:false}}}}});
preset.addEventListener('change',e=>{const mins=+e.target.value;if(!mins)return;const now=new Date(),start=new Date(now-mins*60*1000);const f=d=>d.toISOString().slice(0,16);startDT.value=f(start);endDT.value=f(now);});
loadBtn.onclick=async()=>{const s=new Date(startDT.value),e=new Date(endDT.value);if(isNaN(s)||isNaN(e)||s>=e)return alert('Invalid range');const snap=await db.ref('UpdatedReadings').get();if(!snap.exists())return alert('No data');const d=snap.val();const lbls=[],ecg=[],b=[],a=[];for(const k of Object.keys(d).sort()){const t=parseTimestampKey(k);if(!t)continue;if(t>=s&&t<=e){const r=d[k];lbls.push(t.toLocaleTimeString());ecg.push(r.ECG||null);b.push(r.Temperature?.ObjectTemp||null);a.push(r.Temperature?.AmbientTemp||null);}}if(!lbls.length)return alert('No entries in range');histChart.data.labels=lbls;histChart.data.datasets[0].data=ecg;histChart.data.datasets[1].data=b;histChart.data.datasets[2].data=a;histChart.update();}
function parseTimestampKey(k){try{const[d,t]=k.split('_');const[Y,M,D]=d.split('-').map(Number);const[h,m,s]=t.split('-').map(Number);return new Date(Y,M-1,D,h,m,s);}catch{return null;}}
db.ref('.info/connected').on('value',s=>{const ok=!!s.val();connDot.classList.toggle('connected',ok);connText.innerText=ok?'Connected':'Disconnected';});
</script>
</body>
</html>
